<script src="https://accounts.google.com/gsi/client" async defer></script>

<!--ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢-->
<div id="login-area">
  <h2>TODOãƒªã‚¹ãƒˆ</h2>
  <div
    id="g_id_onload"
    data-client_id="727698954425-acn415cdngffpu2rmraf687kci1nav0s.apps.googleusercontent.com"
    data-callback="handleCredentialResponse"
  ></div>
  <div class="g_id_signin" data-type="standard"></div>
</div>

<script>
  let savedIdToken = "";
  let currentStatus = "not_done";

  function handleCredentialResponse(response) {
    // ã“ã“ã§ ID ãƒˆãƒ¼ã‚¯ãƒ³ãŒè‡ªå‹•çš„ã«å–å¾—ã•ã‚Œã¾ã™ï¼
    savedIdToken = response.credential;
    console.log("Login Successful!:");

    document.getElementById("login-area").style.display = "none";
    document.getElementById("main-app").style.display = "block";
    getList(currentStatus);
  }
</script>

<script>
  function priorityFilter() {
    document.getElementById("priority-button").style.display = "block";
  }
</script>

<!--ã‚¢ãƒ—ãƒªæ“ä½œç”»é¢-->
<div id="main-app" style="display: none" class="form-container">
  <div style="text-align: right">
    <button onclick="logout()">logout</button>
  </div>

  <div class="form-container">
    <h2>TODOãƒªã‚¹ãƒˆ</h2>
    <input
      type="text"
      id="taskInput"
      style="margin-bottom: 20px"
      placeholder="Please enter a new Task"
    />
    <button onclick="priorityFilter()" style="margin-bottom: 20px">
      Taskè¿½åŠ 
    </button>

    <div id="priority-button" style="display: none" class="form-container">
      <button onclick="addTask('high')">é«˜</button>
      <button onclick="addTask('medium')">ä¸­</button>
      <button onclick="addTask('low')">ä½</button>
    </div>

    <!--ã‚²ãƒƒãƒˆãƒªã‚¹ãƒˆã®æ¡ä»¶æŒ‡å®šç”»é¢-->
    <div id="filter-area">
      <button onclick="getList('all')">All</button>
      <button onclick="getList('not_done')">Not Done</button>
      <button onclick="getList('done')">Done</button>
    </div>
  </div>

  <style>
    .form-container {
      text-align: center;
      margin-bottom: 20px;
    }
    /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®æ¨ªå¹…ã‚’100%ã«ã™ã‚‹ */
    #todo-table {
      width: 75%;
      margin-left: auto;
      margin-right: auto;
      border-collapse: collapse; /* æ ç·šã‚’ä¸€æœ¬ã«ã¾ã¨ã‚ã‚‹ */
    }

    /* è¦‹å‡ºã—ã¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«ã«æ ç·šã¨ä½™ç™½ã‚’ã¤ã‘ã‚‹ */
    #todo-table th,
    #todo-table td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
    }

    /* è¦‹å‡ºã—ã«èƒŒæ™¯è‰²ã‚’ã¤ã‘ã¦ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ */
    #todo-table th {
      background-color: #eee;
    }

    #todo-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    /* å®Œäº†æ¸ˆã¿ã®è¡Œã«é©ç”¨ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
    .task-done-row {
      background-color: #f8f9fa; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
      color: #adb5bd; /* æ–‡å­—ã‚’è–„ãã™ã‚‹ */
      text-decoration: line-through; /* æ¨ªç·šã‚’å¼•ã */
    }

    /* ã‚´ãƒŸç®±ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼ï¼ˆãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸæ™‚ï¼‰æ¼”å‡º */
    .delete-btn:hover {
      background-color: #ffcccc; /* è–„ã„èµ¤è‰²ã«ã™ã‚‹ */
      cursor: pointer;
    }
  </style>

  <table id="todo-table">
    <!-- <thead>
      <tr>
        <th>ã‚¿ã‚¹ã‚¯</th>
        <th>å„ªå…ˆåº¦</th>
        <th>çŠ¶æ…‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead> -->
    <tbody id="todo-list-body"></tbody>
  </table>
</div>

<script>
  function getList(status) {
    if (status) {
      currentStatus = status;
    }

    const url = `/todo/getlist?status=${status}`;

    fetch(url, {
      method: "GET",
      headers: {
        Authorization: "Bearer " + savedIdToken,
      },
    })
      .then((response) => response.json())
      .then((todolist) => {
        const list = document.getElementById("todo-list-body");
        list.innerHTML = "";

        todolist.forEach((todo) => {
          // æ–°è¦ç´ ã«taskã‚’ä½œæˆ
          const tr = document.createElement("tr");

          // çŠ¶æ…‹ãŒ "done" ãªã‚‰ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã™ã‚‹
          if (todo.status === "done") {
            tr.classList.add("task-done-row");
          }

          tr.innerHTML = `
            <td>${
              todo.status === "not_done"
                ? `<button onclick="updateTaskStatus(${todo.id},'done')">ã€‡</button>`
                : "âœ…"
            }</td>
            <td>${todo.task}</td>
            <td>${todo.priority}</td>
            <td>${`<button class="delete-btn" onclick="deleteTask(${todo.id},'done')">ğŸ—‘ï¸</button>`}</td>
          `;

          list.appendChild(tr);
        });
      });
  }

  function deleteTask(id) {
    const url = `/todo/delete/${id}`;

    fetch(url, {
      method: "DELETE",
      headers: {
        Authorization: "Bearer " + savedIdToken,
      },
    })
      .then((response) => {
        if (response.ok) {
          console.log("å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸï¼");
          getList(currentStatus);
        } else {
          console.log("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
        }
      })
      .catch((error) => {
        console.error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:", error);
      });
  }

  function updateTaskStatus(id, status) {
    const url = `/todo/update/${id}`;

    fetch(url, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + savedIdToken,
      },
      body: JSON.stringify({
        status: status,
      }),
    })
      .then((response) => {
        if (response.ok) {
          console.log("æ›´æ–°æˆåŠŸï¼");
          getList(currentStatus);
        } else {
          alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      })
      .catch((error) => {
        console.error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:", error);
      });
  }
</script>

<script>
  function logout() {
    savedIdToken = "";

    // å…¥åŠ›æ¬„ã«æ®‹ã£ã¦ã„ã‚‹æ–‡å­—åˆ—å‰Šé™¤
    document.getElementById("taskInput").value = "";

    document.getElementById("login-area").style.display = "block";
    document.getElementById("main-app").style.display = "none";

    console.log("Logged out successfully");
  }
</script>

<!--ã‚¿ã‚¹ã‚¯è¿½åŠ ç³»-->
<script>
  function addTask(status) {
    // addTaskå®Ÿè¡Œå¾Œpriorityé¸æŠãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    document.getElementById("priority-button").style.display = "none";

    const inputElement = document.getElementById("taskInput");
    const taskText = inputElement.value;

    if (taskText === "") {
      alert("Pleas enter something");
      return;
    }

    console.log("I'll send this test now: " + taskText);
    sendTaskToServer(taskText, status);

    inputElement.value = "";
  }

  function sendTaskToServer(task, status) {
    if (savedIdToken === "") {
      alert("Please login to google firstly");
      return;
    }

    fetch("/todo/insert", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + savedIdToken,
      },

      body: JSON.stringify({
        task: task,
        priority: status,
        status: "not_done",
      }),
    }).then((response) => {
      if (response.ok) {
        alert("New task registration completed");
        getList("not_done");
      } else {
        alert("Error occurred");
      }
    });
  }
</script>

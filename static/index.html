<script src="https://accounts.google.com/gsi/client" async defer></script>

<!--ログイン画面-->
<div id="login-area">
  <h2>Todo Management</h2>
  <div
    id="g_id_onload"
    data-client_id="727698954425-acn415cdngffpu2rmraf687kci1nav0s.apps.googleusercontent.com"
    data-callback="handleCredentialResponse"
  ></div>
  <div class="g_id_signin" data-type="standard"></div>
</div>

<script>
  let savedIdToken = "";

  function handleCredentialResponse(response) {
    // ここで ID トークンが自動的に取得されます！
    savedIdToken = response.credential;
    console.log("Login Successful!:");

    document.getElementById("login-area").style.display = "none";
    document.getElementById("main-app").style.display = "block";
  }
</script>

<!--アプリ操作画面-->
<div id="main-app" style="display: none">
  <div style="text-align: right">
    <button onclick="logout()">logout</button>
  </div>

  <h2>My Task Management</h2>
  <input type="text" id="taskInput" placeholder="Please enter a new Task" />
  <button onclick="addTask()">Add Task</button>
  <button onclick="displayFilter()">Get List</button>

  <!--ゲットリストの条件指定画面-->
  <div id="filter-area" style="display: none">
    <button onclick="getList('all')">All</button>
    <button onclick="getList('not_done')">Not Done</button>
    <button onclick="getList('done')">Done</button>
  </div>

  <style>
    /* テーブル全体の横幅を100%にする */
    #todo-table {
      width: 75%;
      margin-left: auto;
      margin-right: auto;
      border-collapse: collapse; /* 枠線を一本にまとめる */
    }

    /* 見出しとデータセルに枠線と余白をつける */
    #todo-table th,
    #todo-table td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
    }

    /* 見出しに背景色をつけてわかりやすくする */
    #todo-table th {
      background-color: #eee;
    }

    #todo-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
  </style>

  <table id="todo-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Task</th>
        <th>priority</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="todo-list-body"></tbody>
  </table>
</div>

<script>
  function displayFilter() {
    const filterArea = document.getElementById("filter-area");

    if (filterArea.style.display === "none") {
      filterArea.style.display = "block";
    } else {
      filterArea.style.display = "none";
    }
  }
</script>

<script>
  function getList(status = "all") {
    const url = `/todo/getlist?status=${status}`;

    fetch(url, {
      method: "GET",
      headers: {
        Authorization: "Bearer " + savedIdToken,
      },
    })
      .then((response) => response.json())
      .then((todolist) => {
        const list = document.getElementById("todo-list-body");
        list.innerHTML = "";

        todolist.forEach((todo) => {
          // 新要素にtaskを作成
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${todo.id}</td>
            <td>${todo.task}</td>
            <td>${todo.priority}</td>
            <td>${todo.status}</td>
            <td>${
              todo.status === "not_done"
                ? `<button onclick="updateTaskStatus(${todo.id},'done')">完了</button>`
                : "✅"
            }</td>
          `;

          list.appendChild(tr);
        });
      });
  }

  function updateTaskStatus(id, status) {
    const url = `/todo/update/${id}`;

    fetch(url, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + savedIdToken,
      },
      body: JSON.stringify({
        status: status,
      }),
    })
      .then((response) => {
        if (response.ok) {
          console.log("更新成功！");
          getList();
        } else {
          alert("更新に失敗しました");
        }
      })
      .catch((error) => {
        console.error("ネットワークエラー:", error);
      });
  }
</script>

<script>
  function logout() {
    savedIdToken = "";

    // 入力欄に残っている文字列削除
    document.getElementById("taskInput").value = "";

    document.getElementById("login-area").style.display = "block";
    document.getElementById("main-app").style.display = "none";

    console.log("Logged out successfully");
  }
</script>

<script>
  function addTask() {
    const inputElement = document.getElementById("taskInput");
    const taskText = inputElement.value;

    if (taskText === "") {
      alert("Pleas enter something");
      return;
    }

    console.log("I'll send this test now: " + taskText);
    sendTaskToServer(taskText);

    inputElement.value = "";
  }

  function sendTaskToServer(taskTitle) {
    if (savedIdToken === "") {
      alert("Please login to google firstly");
      return;
    }

    fetch("/todo/insert", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + savedIdToken,
      },

      body: JSON.stringify({
        task: taskTitle,
        priority: "high",
        status: "not_done",
      }),
    }).then((response) => {
      if (response.ok) {
        alert("New task registration completed");
      } else {
        alert("Error occurred");
      }
    });

    getList();
  }
</script>
